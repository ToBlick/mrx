name: CI

on:
  push:
    branches: [ main, master, docs ]
  pull_request:
    branches: [ main, master, docs ]

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11','3.12']
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff jax jaxlib numpy pytest
        
    - name: Run ruff
      run: |
        ruff check . --ignore F403,F405
        
  test:
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11','3.12']
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jax jaxlib numpy pytest matplotlib plotly optax diffrax h5py xarray h5netcdf
        
    - name: Run tests
      run: |
        pytest test
        
  script-test:
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12']  # Avoid excessive runtime by only testing with Python 3.12
        script: [
          'scripts/interactive/test_gvec_stellarator.py',
          'scripts/interactive/test_gvec_tokamak.py',
          'scripts/interactive/cylinder_vector_poisson.py',
          'scripts/interactive/toroid_cavity.py',
          'scripts/interactive/toroid_poisson.py',
          'scripts/interactive/cylinder_cavity.py',
          'scripts/interactive/cylinder_vector_poisson.py',
          'scripts/interactive/drumshape.py',
          'scripts/tutorials/polar_poisson.py',
          'scripts/tutorials/toroid_poisson.py',
          'scripts/tutorials/mixed_polar_poisson.py',
          'scripts/config_scripts/iter_islands.py',
          'scripts/config_scripts/stell.py',
          'scripts/config_scripts/solovev.py',
        ]
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jax jaxlib numpy matplotlib optax diffrax h5py xarray h5netcdf
        
    - name: Install mrx package
      run: |
        pip install -e .
        
    - name: Run script
      env:
        MPLBACKEND: Agg
      timeout-minutes: 10
      run: |
        # Try with maxit=10 for config scripts, fallback to default args, then no args
        python ${{ matrix.script }} maxit=10 run_name=ci_test || python ${{ matrix.script }} 8 3 || python ${{ matrix.script }} run_name=ci_test || python ${{ matrix.script }}

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Upgrade pip and install mrx
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install sphinx and its dependencies for building docs
        run: |
          pip install -r docs/requirements.txt

      - name: Install doxygen and pandoc
        run: |
          sudo apt update
          sudo apt install -y doxygen pandoc

      - name: Build docs
        run: |
          cd docs
          sphinx-build -b html source build
